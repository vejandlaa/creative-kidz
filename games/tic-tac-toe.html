<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tic Tac Toe</title>
    <style>
        :root {
            --bg-color: #f4f7f6;
            --panel-bg: #ffffff;
            --accent: #00bcd4;
            --cell-size: 100px;
            --focus-outline: 4px solid #ffca28;
        }

        body {
            font-family: 'Segoe UI', 'Comic Sans MS', sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; user-select: none; -webkit-user-select: none;
        }

        h1 { color: #37474f; margin: 0 0 15px 0; text-align: center; }

        /* --- LAYOUT --- */
        .dashboard {
            display: flex; flex-direction: row; gap: 20px;
            width: 100%; max-width: 1200px; justify-content: center; align-items: flex-start;
        }

        @media (max-width: 900px) {
            .dashboard { flex-direction: column; align-items: center; }
            .panel { width: 95% !important; }
            .side-collection { width: 95% !important; height: auto !important; flex-direction: row !important; min-height: 100px; }
        }

        /* --- PANELS --- */
        .panel {
            background: var(--panel-bg); border-radius: 20px; padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            display: flex; flex-direction: column; align-items: center;
        }

        /* Setup Panel */
        .panel-setup { width: 260px; flex-shrink: 0; }
        .control-group { width: 100%; margin-bottom: 15px; text-align: center; }
        .control-label { font-weight: bold; color: #78909c; font-size: 0.85rem; margin-bottom: 5px; display: block; text-transform: uppercase; letter-spacing: 1px;}

        .btn-group { display: flex; gap: 5px; width: 100%; }
        .btn-toggle {
            padding: 10px; border: 2px solid #eee; background: white;
            border-radius: 8px; cursor: pointer; font-weight: bold; color: #555;
            flex: 1; transition: all 0.2s; font-size: 0.9rem;
        }
        .btn-toggle.active { background: var(--accent); color: white; border-color: var(--accent); }

        .avatar-grid-mini { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; width: 100%; }
        .mini-avatar {
            aspect-ratio: 1; border: 2px solid #eee; border-radius: 8px; cursor: pointer;
            display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden;
            transition: transform 0.1s;
        }
        .mini-avatar.active { border-color: var(--accent); background: #e0f7fa; transform: scale(1.05); }
        .mini-avatar.locked { cursor: not-allowed; opacity: 0.5; filter: grayscale(0.5); pointer-events: none; }
        .mini-avatar.locked.active { opacity: 1; filter: none; border-color: #ff9800; background: #fff3e0; }

        /* Game Panel */
        .panel-game { flex: 1; min-width: 300px; display: flex; flex-direction: column; align-items: center; }

        .scoreboard { display: flex; gap: 15px; margin-bottom: 15px; width: 100%; justify-content: center; }
        .score-card { text-align: center; padding: 5px 15px; background: #fafafa; border-radius: 10px; min-width: 60px; border: 1px solid #eee;}
        .score-num { font-size: 1.4rem; font-weight: 900; }
        .p1-color { color: #e57373; }
        .p2-color { color: #64b5f6; }

        /* --- THE GRID FIX --- */
        .board {
            display: grid;
            /* minmax(0, 1fr) prevents the grid from expanding when a large image is added */
            grid-template-columns: repeat(3, minmax(0, 1fr));
            grid-template-rows: repeat(3, minmax(0, 1fr));
            gap: 8px;
            width: 100%; max-width: 380px; aspect-ratio: 1;
            background: #cfd8dc; border: 8px solid #cfd8dc; border-radius: 15px;
        }
        .cell {
            background: white; border-radius: 8px; cursor: pointer;
            display: flex; justify-content: center; align-items: center; position: relative;
            overflow: visible; touch-action: manipulation;
        }
        .cell:active { transform: scale(0.95); }

        /* Prize Panel */
        .panel-prizes { width: 180px; flex-shrink: 0; min-height: 400px; }
        .shelf {
            width: 100%; flex: 1; background: #fff8e1; border-radius: 10px;
            margin-bottom: 10px; padding: 8px;
            display: flex; flex-wrap: wrap; align-content: flex-start; gap: 8px; overflow-y: auto;
        }
        .mini-toy {
            width: 40px; height: 40px; background: white; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; font-size: 1.2rem;
            position: relative; border: 2px solid #ffe082; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .mini-toy-count {
            position: absolute; bottom: -5px; right: -5px; font-size: 0.7rem;
            background: #ff5252; color: white; padding: 1px 5px; border-radius: 10px; font-weight: bold;
        }

        /* --- DRAWING OVERLAY --- */
        #draw-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        #draw-overlay.hidden { display: none !important; }

        .draw-modal {
            background: white; padding: 20px; border-radius: 20px;
            display: flex; flex-direction: column; align-items: center;
            width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        canvas { border: 4px solid #333; border-radius: 10px; cursor: crosshair; touch-action: none; background: white; margin: 10px 0; }
        .palette { display: flex; gap: 10px; margin-bottom: 15px; }
        .swatch { width: 35px; height: 35px; border-radius: 50%; cursor: pointer; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .swatch.active { transform: scale(1.2); border-color: #333; }

        /* --- AVATAR GRAPHICS (FIXED FOR GRID) --- */
        .avatar-wrapper {
            width: 100%; height: 100%; position: relative;
            display: flex; justify-content: center; align-items: center;
        }
        /* Important: Ensure custom images never exceed their container */
        .custom-img {
            max-width: 90%; max-height: 90%; width: auto; height: auto;
            object-fit: contain; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
        }

        .mon-green { width: 75%; height: 75%; background: #8bc34a; border-radius: 50%; border: 3px solid #33691e; position: relative; }
        .mon-green::after { content: ''; position: absolute; top: 25%; left: 25%; width: 50%; height: 50%; background: white; border-radius: 50%; border: 2px solid black; }
        .mon-green::before { content: ''; position: absolute; top: 45%; left: 45%; width: 15%; height: 15%; background: black; border-radius: 50%; z-index: 2; }

        .mon-blue { width: 75%; height: 75%; background: #42a5f5; border-radius: 15%; border: 3px solid #0d47a1; position: relative; }
        .mon-blue .eye { position: absolute; top: 30%; width: 25%; height: 25%; background: white; border: 2px solid black; border-radius: 50%; }
        .mon-blue .eye.l { left: 15%; } .mon-blue .eye.r { right: 15%; }
        .mon-blue::after { content: ''; position: absolute; bottom: 20%; left: 40%; width: 20%; height: 20%; background: pink; border: 2px solid black; border-radius: 0 0 10px 10px; }

        .mon-orange { width: 65%; height: 85%; background: #ff9800; border-radius: 50%; border: 3px solid #e65100; position: relative; }
        .mon-orange::after { content: ''; position: absolute; top: 40%; left: 15%; width: 70%; height: 30%; background: white; border-radius: 50%; border: 2px solid black; }
        .mon-orange::before { content: ''; position: absolute; top: 50%; left: 45%; width: 10%; height: 10%; background: black; border-radius: 50%; z-index: 2; }

        .mon-purple { width: 75%; height: 75%; background: #9c27b0; position: relative; clip-path: polygon(0% 20%, 20% 0%, 40% 20%, 60% 0%, 80% 20%, 100% 0%, 100% 100%, 0% 100%); }
        .mon-purple .eye { position: absolute; top: 40%; width: 25%; height: 10%; background: white; border: 1px solid black; }
        .mon-purple .eye.l { left: 15%; transform: rotate(15deg); } .mon-purple .eye.r { right: 15%; transform: rotate(-15deg); }

        /* Animations */
        .winner-anim { animation: bounce 0.6s infinite; }
        @keyframes bounce { 0% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .prize-drop { position: absolute; font-size: 2.5rem; z-index: 10; animation: drop 1s forwards; }
        @keyframes drop { 0% { transform: translateY(-50px) scale(0); } 100% { transform: translateY(0) scale(1); } }
        .sinking-anim { animation: sink 3s forwards; }
        @keyframes sink { 100% { transform: translateY(30px); opacity: 0; } }
        .rain-cloud { position: absolute; top: -30px; font-size: 2rem; z-index: 5; left: 50%; transform: translateX(-50%); }
        .rain-drop { position: absolute; width: 2px; height: 10px; background: blue; animation: rain 0.5s infinite linear; top: 0; }
        @keyframes rain { to { transform: translateY(60px); opacity: 0; } }

    </style>
</head>
<body>

<h1>Tic Tac Toe</h1>

<div class="dashboard">

    <div class="panel panel-setup">
        <div class="control-group">
            <span class="control-label">Game Mode</span>
            <div class="btn-group">
                <button class="btn-toggle active" id="mode-pvc" onclick="game.setMode('pvc')">1 Player</button>
                <button class="btn-toggle" id="mode-pvp" onclick="game.setMode('pvp')">2 Players</button>
            </div>
        </div>

        <div class="control-group">
            <span class="control-label">You (Player 1)</span>
            <div class="avatar-grid-mini" id="p1-grid"></div>
            <button style="margin-top:5px; width:100%; padding:5px; cursor:pointer;" onclick="painter.open('p1')" class="btn-toggle">üé® Paint New</button>
        </div>

        <div class="control-group">
            <span class="control-label" id="p2-label">Computer</span>
            <div class="avatar-grid-mini" id="p2-grid"></div>
            <button id="p2-paint-btn" style="margin-top:5px; width:100%; padding:5px; cursor:pointer;" onclick="painter.open('p2')" class="btn-toggle hidden">üé® Paint New</button>
        </div>

        <div class="control-group">
            <span class="control-label">Who Starts?</span>
            <div class="btn-group">
                <button class="btn-toggle active" id="start-p1" onclick="game.setStarter('p1')">Me</button>
                <button class="btn-toggle" id="start-p2" onclick="game.setStarter('p2')">Them</button>
            </div>
        </div>

        <button class="btn-toggle" style="background:#ef5350; color:white; width:100%; margin-top:10px;" onclick="game.reset()">Restart Game</button>
    </div>

    <div class="panel panel-game">
        <div class="scoreboard">
            <div class="score-card">
                <div class="control-label p1-color">P1</div>
                <div class="score-num p1-color" id="score-p1">0</div>
            </div>
            <div style="display:flex; align-items:center;">
                <span id="status-text" style="font-weight:bold; color:#555;">P1 Turn</span>
            </div>
            <div class="score-card">
                <div class="control-label p2-color">P2</div>
                <div class="score-num p2-color" id="score-p2">0</div>
            </div>
        </div>

        <div class="board" id="board"></div>
    </div>

    <div class="panel panel-prizes">
        <div class="control-label p1-color">P1 Collection</div>
        <div class="shelf" id="shelf-p1"></div>

        <div class="control-label p2-color" style="margin-top:10px;">P2 Collection</div>
        <div class="shelf" id="shelf-p2"></div>
    </div>

</div>

<div id="draw-overlay" class="hidden">
    <div class="draw-modal">
        <h2 style="margin-top:0;">Paint Avatar</h2>
        <canvas id="canvas" width="280" height="280"></canvas>
        <div class="palette">
            <div class="swatch active" style="background:black" onclick="painter.setColor('black', this)"></div>
            <div class="swatch" style="background:#e57373" onclick="painter.setColor('#e57373', this)"></div>
            <div class="swatch" style="background:#81c784" onclick="painter.setColor('#81c784', this)"></div>
            <div class="swatch" style="background:#64b5f6" onclick="painter.setColor('#64b5f6', this)"></div>
        </div>
        <div style="display:flex; gap:10px; width:100%;">
            <button class="btn-toggle" onclick="painter.clear()">Clear</button>
            <button class="btn-toggle active" onclick="painter.save()">Save</button>
            <button class="btn-toggle" onclick="painter.close()">Cancel</button>
        </div>
    </div>
</div>

<script>
    const game = {
        mode: 'pvc',
        starter: 'p1',
        turn: 'p1',
        active: true,
        board: Array(9).fill(''),
        scores: { p1: 0, p2: 0 },
        toys: { p1: {}, p2: {} },
        p1Avatar: 'green',
        p2Avatar: 'blue',
        p1Custom: null,
        p2Custom: null,

        init: function() {
            if(this.p1Avatar === this.p2Avatar) this.randomizeBot();
            ui.renderSelectors();
            ui.renderBoard();
            ui.updateShelves();
        },

        setMode: function(m) {
            this.mode = m;
            document.getElementById('mode-pvc').className = m === 'pvc' ? 'btn-toggle active' : 'btn-toggle';
            document.getElementById('mode-pvp').className = m === 'pvp' ? 'btn-toggle active' : 'btn-toggle';
            document.getElementById('p2-label').innerText = m === 'pvc' ? "Computer" : "Player 2";

            const p2Paint = document.getElementById('p2-paint-btn');
            if(m === 'pvc') p2Paint.classList.add('hidden');
            else p2Paint.classList.remove('hidden');

            if(m === 'pvc') {
                if(this.p1Avatar === this.p2Avatar) this.randomizeBot();
            }

            ui.renderSelectors();
            this.reset();
        },

        setStarter: function(p) {
            this.starter = p;
            document.querySelectorAll('#start-p1, #start-p2').forEach(b => b.classList.remove('active'));
            document.getElementById(`start-${p}`).classList.add('active');
            this.reset();
        },

        setAvatar: function(player, type) {
            if(this.mode === 'pvc' && player === 'p2') return;

            if(player === 'p1') {
                this.p1Avatar = type;
                this.p1Custom = null;
                if(this.mode === 'pvc' && this.p2Avatar === type) {
                    this.randomizeBot();
                }
            } else {
                this.p2Avatar = type;
                this.p2Custom = null;
            }
            ui.renderSelectors();
            ui.renderBoard();
        },

        randomizeBot: function() {
            const keys = Object.keys(ui.avatars);
            const available = keys.filter(k => k !== this.p1Avatar);
            this.p2Avatar = available[Math.floor(Math.random() * available.length)];
            this.p2Custom = null;
        },

        reset: function() {
            this.board.fill('');
            this.active = true;
            this.turn = this.starter;
            ui.renderBoard();
            ui.updateStatus();
            if(this.mode === 'pvc' && this.turn === 'p2') setTimeout(() => ai.move(), 600);
        },

        clickCell: function(i) {
            if(!this.active || this.board[i]) return;
            if(this.mode === 'pvc' && this.turn === 'p2') return;
            this.executeMove(i);
        },

        executeMove: function(i) {
            this.board[i] = this.turn;
            ui.renderBoard();

            if(this.checkWin()) { this.endGame(this.turn); return; }
            if(!this.board.includes('')) { this.endGame('draw'); return; }

            this.turn = this.turn === 'p1' ? 'p2' : 'p1';
            ui.updateStatus();

            if(this.mode === 'pvc' && this.turn === 'p2') setTimeout(() => ai.move(), 600);
        },

        checkWin: function() {
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            return wins.some(w => this.board[w[0]] === this.turn && this.board[w[1]] === this.turn && this.board[w[2]] === this.turn);
        },

        endGame: function(winner) {
            this.active = false;
            const txt = document.getElementById('status-text');

            if(winner === 'draw') {
                txt.innerText = "Draw!";
                ui.triggerRain(null);
            } else {
                txt.innerText = (winner === 'p1' ? "P1" : "P2") + " Wins!";
                this.scores[winner]++;
                document.getElementById(`score-${winner}`).innerText = this.scores[winner];

                const toysList = ['üß∏','ü¶ñ','ü¶Ñ','ü§ñ','ü¶Ü','üèéÔ∏è','üöÄ','üçï'];
                const prize = toysList[Math.floor(Math.random() * toysList.length)];

                if(!this.toys[winner][prize]) this.toys[winner][prize] = 0;
                this.toys[winner][prize]++;
                ui.updateShelves();

                ui.triggerWin(winner, prize);
            }
        }
    };

    const ui = {
        avatars: {
            green: `<div class="mon-green"></div>`,
            blue: `<div class="mon-blue"><div class="eye l"></div><div class="eye r"></div></div>`,
            orange: `<div class="mon-orange"></div>`,
            purple: `<div class="mon-purple"><div class="eye l"></div><div class="eye r"></div></div>`
        },

        renderSelectors: function() {
            ['p1', 'p2'].forEach(p => {
                const el = document.getElementById(`${p}-grid`);
                el.innerHTML = '';
                const isLocked = (p === 'p2' && game.mode === 'pvc');

                Object.keys(this.avatars).forEach(key => {
                    const div = document.createElement('div');
                    let classes = 'mini-avatar';
                    if(game[`${p}Avatar`] === key && !game[`${p}Custom`]) classes += ' active';
                    if(isLocked) classes += ' locked';

                    div.className = classes;
                    div.innerHTML = `<div class="avatar-wrapper" style="transform:scale(0.6)">${this.avatars[key]}</div>`;

                    if(!isLocked) div.onclick = () => game.setAvatar(p, key);

                    el.appendChild(div);
                });

                if(game[`${p}Custom`]) {
                    const div = document.createElement('div');
                    div.className = 'mini-avatar active';
                    div.innerHTML = 'üé®';
                    el.appendChild(div);
                }
            });
        },

        renderBoard: function() {
            const el = document.getElementById('board');
            el.innerHTML = '';
            game.board.forEach((val, i) => {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.onclick = () => game.clickCell(i);
                if(val) {
                    let html = '';
                    if(game[`${val}Custom`]) html = `<img src="${game[`${val}Custom`]}" class="custom-img">`;
                    else html = this.avatars[game[`${val}Avatar`]];
                    cell.innerHTML = `<div class="avatar-wrapper">${html}</div>`;
                }
                el.appendChild(cell);
            });
        },

        updateStatus: function() {
            const txt = document.getElementById('status-text');
            if(!game.active) return;
            const name = game.turn === 'p1' ? "P1 Turn" : (game.mode === 'pvc' ? "Bot Turn" : "P2 Turn");
            txt.innerText = name;
            txt.style.color = game.turn === 'p1' ? '#e57373' : '#64b5f6';
        },

        updateShelves: function() {
            ['p1', 'p2'].forEach(p => {
                const el = document.getElementById(`shelf-${p}`);
                el.innerHTML = '';
                for(let t in game.toys[p]) {
                    const d = document.createElement('div');
                    d.className = 'mini-toy';
                    d.innerHTML = `${t}<div class="mini-toy-count">${game.toys[p][t]}</div>`;
                    el.appendChild(d);
                }
            });
        },

        triggerWin: function(winner, prize) {
            const cells = document.getElementById('board').children;
            game.board.forEach((val, i) => {
                if(val === winner) {
                    const w = cells[i].querySelector('.avatar-wrapper');
                    if(w) w.classList.add('winner-anim');
                    const p = document.createElement('div');
                    p.className = 'prize-drop'; p.innerText = prize;
                    cells[i].appendChild(p);
                } else if(val) {
                    this.addRain(cells[i]);
                }
            });
        },

        triggerRain: function(target) {
            const cells = document.getElementById('board').children;
            game.board.forEach((val, i) => {
                if(val) this.addRain(cells[i]);
            });
        },

        addRain: function(cell) {
            const w = cell.querySelector('.avatar-wrapper');
            if(w) w.classList.add('sinking-anim');
            const c = document.createElement('div'); c.className = 'rain-cloud'; c.innerText = 'üåßÔ∏è';
            cell.appendChild(c);
            for(let k=0; k<3; k++){
                const d = document.createElement('div'); d.className='rain-drop';
                d.style.left = (20+k*30)+'%'; d.style.animationDelay=(k*0.2)+'s';
                cell.appendChild(d);
            }
        }
    };

    const ai = {
        move: function() {
            const empty = game.board.map((v, i) => v === '' ? i : null).filter(v => v !== null);
            if(empty.length === 0) return;
            let move = this.findWin('p2') || this.findWin('p1') || empty[Math.floor(Math.random() * empty.length)];
            game.executeMove(move);
        },
        findWin: function(player) {
            const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
            for(let w of wins) {
                const [a,b,c] = w;
                const l = [game.board[a], game.board[b], game.board[c]];
                if(l.filter(x => x === player).length === 2 && l.includes('')) {
                    if(game.board[a] === '') return a;
                    if(game.board[b] === '') return b;
                    if(game.board[c] === '') return c;
                }
            }
            return null;
        }
    };

    const painter = {
        target: 'p1',
        canvas: document.getElementById('canvas'),
        ctx: document.getElementById('canvas').getContext('2d'),
        color: 'black',
        isDrawing: false,

        open: function(p) {
            this.target = p;
            document.getElementById('draw-overlay').classList.remove('hidden');
            this.clear();
        },
        close: function() {
            document.getElementById('draw-overlay').classList.add('hidden');
        },
        clear: function() {
            this.ctx.clearRect(0,0,280,280);
        },
        setColor: function(c, el) {
            this.color = c;
            document.querySelectorAll('.swatch').forEach(s => s.classList.remove('active'));
            el.classList.add('active');
        },
        save: function() {
            game[`${this.target}Custom`] = this.canvas.toDataURL();
            ui.renderSelectors();
            game.reset();
            this.close();
        },

        init: function() {
            const c = this.canvas;
            c.addEventListener('mousedown', e => this.start(e.offsetX, e.offsetY));
            c.addEventListener('mousemove', e => this.move(e.offsetX, e.offsetY));
            c.addEventListener('mouseup', () => this.stop());
            c.addEventListener('touchstart', e => { e.preventDefault(); const r = c.getBoundingClientRect(); this.start(e.touches[0].clientX - r.left, e.touches[0].clientY - r.top); });
            c.addEventListener('touchmove', e => { e.preventDefault(); const r = c.getBoundingClientRect(); this.move(e.touches[0].clientX - r.left, e.touches[0].clientY - r.top); });
            c.addEventListener('touchend', () => this.stop());
        },
        start: function(x, y) { this.isDrawing = true; this.ctx.beginPath(); this.ctx.moveTo(x, y); this.ctx.lineWidth = 8; this.ctx.lineCap = 'round'; this.ctx.strokeStyle = this.color; },
        move: function(x, y) { if(this.isDrawing) { this.ctx.lineTo(x, y); this.ctx.stroke(); } },
        stop: function() { this.isDrawing = false; this.ctx.beginPath(); }
    };

    window.addEventListener('DOMContentLoaded', () => { painter.init(); game.init(); });

</script>
</body>
</html>